/**
 * @package filter_translations
 * @author Andrew Hancox <andrewdchancox@googlemail.com>
 * @author Open Source Learning <enquiries@opensourcelearning.co.uk>
 * @link https://opensourcelearning.co.uk
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @copyright 2021, Andrew Hancox
 */
define("filter_translations/translation_button",["jquery","core/modal_factory","core/str","core/templates"],(function($,ModalFactory,Str,templates){var translation_button={returnurl:"",init:function(returnurl){translation_button.returnurl=returnurl,$("body").on("click",".filter_translations_btn_translate",translation_button.opentranslation),$("body").on("contextmenu",".filter_translations_btn_translate",translation_button.opentranslation)},findandinjectbuttons:function(){var elems=translation_button.findElementsDirectlyContainingText(document,"‍‍");let itemsprocessed=0,missingitems=[];elems.forEach((function(elem){var matches=new RegExp("‍‍([​‌]*)"),regexzero=new RegExp("‌","g"),regexone=new RegExp("​","g"),binary=matches.exec($(elem).html())[1].replace(regexone,"1").replace(regexzero,"0"),key=parseInt(binary,2),translationinfo=translation_button.objects[key];templates.render("filter_translations/translatebutton",translationinfo).done((function(html){if($(elem).append(html),1==translationinfo.notranslation&&(console.log(translationinfo.rawtext),missingitems.includes(translationinfo.generatedhash)||missingitems.push(translationinfo.generatedhash)),itemsprocessed++,itemsprocessed===elems.length){const titlemissing=document.querySelectorAll("title .icon-translate-cross").length,missingitemscount=missingitems.length-titlemissing;let stalecount=0;for(let k in translation_button.objects)translation_button.objects[k].staletranslation&&(stalecount+=1);const totalcount=stalecount+missingitemscount;$(".translation-icon-wrapper i").after('<div class="count-container " data-region="count-container">'+translation_button.cap_count(totalcount)+"</div>"),$(".translation-icon-wrapper a.missingonthispage").html($(".translation-icon-wrapper a.missingonthispage").html()+" ("+translation_button.cap_count(missingitemscount)+")"),$(".translation-icon-wrapper a.staleonthispage").html($(".translation-icon-wrapper a.staleonthispage").html()+" ("+translation_button.cap_count(stalecount)+")")}}))}))},opentranslation:function(event){event.stopPropagation(),event.preventDefault();var context=translation_button.objects[$(this).data("inpagetranslationid")];context.returnurl=translation_button.returnurl,Str.get_strings([{key:"translationdetails",component:"filter_translations"}]).then((function(langStrings){return templates.render("filter_translations/translationdetailsmodalbody",context).done((function(html){ModalFactory.create({title:langStrings[0],body:html,type:ModalFactory.types.ALERT}).then((function(modal){modal.show()}))}))})).fail(Notification.exception)},register:function(key,translationinfo){translation_button.objects[key]=translationinfo},findElementsDirectlyContainingText:function(ancestor,text){var elements=[];return function walk(element){for(var n=element.childNodes.length,i=0;i<n;i++){if(3===(child=element.childNodes[i]).nodeType&&-1!==child.data.indexOf(text)){elements.push(element);break}}for(i=0;i<n;i++){var child;1===(child=element.childNodes[i]).nodeType&&walk(child)}}(ancestor),elements},cap_count:function(count){return count<100?count:"99+"},objects:{}};return translation_button}));

//# sourceMappingURL=translation_button.min.js.map